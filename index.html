<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Forkphorus is a JavaScript compiler for Scratch 2 and Scratch 3 projects.">
  <title>forkphorus - phosphorus for Scratch 3</title>
  <meta name="google-site-verification" content="fxogd82_Q_zvblLPSbkmRDktBJG5MK8mH8Xeg8ONDEc" />
  <script>
    // I've seen a non-zero amount of people use forkphorus.github.io/forkphorus/ when they should be using forkphorus.github.io/, so we'll just redirect them to the correct location and hope they take note.
    if (location.origin === 'https://forkphorus.github.io' && location.pathname === '/forkphorus/') {
      location.pathname = '/';
    }

    // Apply local dark mode preference very early to avoid a flash of white
    (function() {
      try {
        if (localStorage.getItem('userPrefersDark') === 'true') {
          document.documentElement.classList.add('dark');
        }
      } catch (e) {
        console.error('error loading theme choice', e);
      }
    }());
  </script>
  <link rel="stylesheet" href="phosphorus.css">
  <link rel="stylesheet" href="player.css">
  <link rel="stylesheet" href="studioview/studioview.css">
  <link rel="stylesheet" href="index.css">
</head>

<body>

  <div class="theme-select">
    <a class="switch-theme">switch theme</a>
  </div>

  <div id="app">

    <div class="area" id="title-area">
      <h1 class="title">forkphorus</h1>
      <p>forkphorus runs Scratch 2 and Scratch 3 projects really fast by compiling them to JavaScript. Try it out by pasting a project ID or URL into the field below, <a class="upload-button"><input id="upload-file-input" type="file" autocomplete="off" accept=".sb2,.sb3">selecting a project file</a>, dropping a file on the page, or <a id="examples">exploring the examples studio</a>.</p>
    </div>

    <div id="examples-container" class="area">
      <div id="examples-view"></div>
      <div id="examples-footer"></div>
    </div>

    <div class="area" id="player-area"></div>

    <div class="title">
      <input class="url" value="https://scratch.mit.edu/projects/" spellcheck="false">
      <a target="_blank" class="project-link" title="View project on Scratch" rel="noopener" href="https://scratch.mit.edu/"></a>
    </div>

    <div class="area" id="project-area">

      <section>
        <h1>Report a problem</h1>
        <p>forkphorus is still in development and has many bugs. <a id="bug-link" target="_blank" rel="noopener" href="https://github.com/forkphorus/forkphorus/issues/new">Click here</a> to report a problem with this project.</p>
      </section>

      <section class=package>
        <h1>Embed this project</h1>
        <p>Include the forkphorus player in your web site.</p>
        <p class="embed-options">
          <input readonly id=embed-code>
          <input type=checkbox id=embed-auto-start checked>
          <label for=embed-auto-start>Start automatically</label>
          <input type=checkbox id=embed-light-content>
          <label for=embed-light-content>Light controls</label>
          <input type=checkbox id=embed-hide-controls>
          <label for=embed-hide-controls>Hide UI</label>
        </p>
      </section>

      <section class=package>
        <h1>Package this project</h1>
        <p>Get a link to a web page that automatically runs your project. To package to HTML, EXE, APK, or other formats, use the <a href="packager/">HTML packager</a>.</p>
        <p class="package-options">
          <a href=# target=_blank id=package-link>Package</a>
          <input type=checkbox id=package-turbo>
          <label for=package-turbo>Turbo mode</label>
          <input type=checkbox id=package-full-screen checked>
          <label for=package-full-screen>Full screen</label>
        </p>
      </section>

      <h1>Settings</h1>
      <table id="settings">
        <tr>
          <td class="name" title="Forkphorus will **attempt** to run at this framerate."><label for="settings-framerate">Framerate (FPS)</label></td>
          <td class="value"><input id="settings-framerate" value="30" placeholder="30" type="number" step="any" min="0" required></td>
        </tr>
        <tr>
          <td class="name" title="The value of the &quot;username&quot; block. Changing this may cause issues in some projects."><label for="settings-username">Username</label></td>
          <!-- scratch has some restrictions on usernames that we don't care about -->
          <td class="value"><input id="settings-username" value="" type="text" placeholder="(nothing)"></td>
        </tr>
      </table>
      <p>Changes are applied automatically.</p>
    </div>

    <section>
      <h1>Credits</h1>
      <p>forkphorus is a fork of <a href="https://phosphorus.github.io/">phosphorus</a> by <a href="https://github.com/nathan">Nathan</a>. Its CPS-style compilation and overall design was inspired by <a href="https://github.com/RHY3756547">Rhys</a>'s <a href="https://code.google.com/p/sb2-js/">sb2.js</a>. It would have more bugs if not for <a href="https://github.com/trumank">Truman</a> and <a href="https://github.com/tjvr">Tim</a>. The <a href="https://stuk.github.io/jszip/">JSZip</a> library is used to read <code>.sb2</code> and <code>.sb3</code> files.</p>

      <h1>Code</h1>
      <p>The source code for forkphorus is available <a href=https://github.com/forkphorus/forkphorus>on GitHub</a>.</p>

      <!-- the deploy bot for forkphorus.github.io will replace this next line with the version info -->
      <p style="opacity: 0.5"><small>Version 236381f, updated 2019-07-24.</small></p>
    </section>
  </div>

  <script src="lib/jszip.min.js"></script>
  <script src="lib/fontfaceobserver.standalone.js"></script>
  <script src="lib/stackblur.min.js"></script>
  <script src="lib/rgbcolor.js"></script>
  <script src="lib/canvg.min.js"></script>
  <script src="phosphorus.dist.js"></script>
  <script src="player.js"></script>
  <script src="studioview/studioview.js"></script>

  <script>

  if (!window.P || !window.P.IO) {
    document.getElementById('title-area').innerHTML += '<p><b>This browser is not supported.</b> Please upgrade to Mozilla Firefox, Google Chrome, or Microsoft Edge.</p>'
  }

  (function() {
    'use strict';

    /** Utilities **/
    // document.querySelector but it throws if your selector failed
    function querySelector(selector) {
      var el = document.querySelector(selector);
      if (!el) {
        throw new Error('Selector returned nothing: ' + selector);
      }
      return el;
    }

    // Shallowly clones an object (member values are not cloned)
    function shallowClone(obj) {
      var result = {};
      for (var k in obj) {
        result[k] = obj[k];
      }
      return result;
    }

    /** Constants **/
    var PROJECT_PREFIX = 'https://scratch.mit.edu/projects/';
    var STUDIO_PREFIX = 'https://scratch.mit.edu/studios/';
    var STUDIO = '15926401';

    /** Core Player Logic **/
    var titleArea = querySelector('#title-area');
    var playerArea = querySelector('#player-area');
    var projectArea = querySelector('#project-area');

    var player = new P.Player();
    window.player = player;
    player.addControls({});
    new P.Player.ProgressBar(player, {
      position: querySelector('.url').parentNode,
    });
    var errorHandler = new P.Player.ErrorHandler(player);
    playerArea.appendChild(player.root);

    var initialId = location.hash.substr(1);
    if (!/^\d+$/.test(initialId)) {
      initialId = '';
    }

    playerArea.style.height = projectArea.style.height = 'auto';
    var titleAreaHeight = titleArea.offsetHeight;
    var playerAreaHeight = playerArea.offsetHeight;
    var projectAreaHeight = projectArea.offsetHeight;
    var studioViewAreaHeight = 330;
    playerArea.style.height = projectArea.style.height = 0;

    var urlInput = querySelector('.url');
    urlInput.value = PROJECT_PREFIX + initialId;

    var projectLink = querySelector('.project-link');
    var bugLink = querySelector('#bug-link');

    var timeout;
    urlInput.addEventListener('input', function() {
      var ss = urlInput.selectionStart;
      var se = urlInput.selectionEnd;
      var url = urlInput.value;
      var id = url.match(/\d+/g) || [''];
      while (id.length > 1 && id.indexOf(player.projectId) > -1) {
        id.splice(id.indexOf(player.projectId), 1);
      }
      id = id[0];
      urlInput.value = url = PROJECT_PREFIX + id;
      urlInput.selectionStart = urlInput.selectionEnd = Math.max(PROJECT_PREFIX.length, ss);
      clearTimeout(timeout);
      if (player.projectId !== id) {
        timeout = setTimeout(function() {
          location.hash = '#' + id;
        }, 300);
      }
    });
    urlInput.addEventListener('focus', function() {
      setTimeout(function() {
        if (/\d/.test(urlInput.value)) {
          urlInput.select();
        }
      });
    });
    var ignoreNextHashChange = false;
    window.addEventListener('hashchange', function() {
      if (ignoreNextHashChange) {
        ignoreNextHashChange = false;
        return;
      }
      var id = location.hash.substr(1);
      if (/^\d+$/.test(id)) {
        urlInput.value = PROJECT_PREFIX + id;
        loadProjectId(id);
      } else {
        hidePlayerArea();
      }
    });
    // Change location.hash w/o firing the hashchange event (or at least make it cancel)
    // Include the leading # in the provided hash
    function silentChangeHash(hash) {
      if (location.hash === hash) return;
      ignoreNextHashChange = true;
      location.hash = hash;
    }

    function hidePlayerArea() {
      titleArea.style.height = titleAreaHeight + 'px';
      playerArea.style.height = '0px';
      projectArea.style.height = '0px';
      urlInput.focus();
      player.cleanup();
      if (studioView && studioView.visible) {
        examplesContainer.style.height = studioViewAreaHeight + 'px';
        examplesViewContainer.appendChild(studioView.root);
      }
    }
    function showPlayerArea() {
      titleArea.style.height = '0px';
      playerArea.style.height = playerAreaHeight + 'px';
      projectArea.style.height = projectAreaHeight + 'px';
      hideStudioView();
      examplesContainer.style.height = '0px';
    }
    function loadProjectId(id) {
      showPlayerArea();
      player.loadProjectId(id);
      updateLinks();
    }
    function loadProjectFile(file) {
      var extension = file.name.split('.').pop();
      if (!['sb2', 'sb3'].includes(extension)) {
        return;
      }
      silentChangeHash('#' + file.name);
      showPlayerArea();
      player.loadProjectFile(file);
      updateLinks();
    }
    function updateLinks() {
      projectLink.href = player.projectLink;
      bugLink.href = errorHandler.createBugReportLink(player.getString('bug.manual.instructions'));
      updatePackageLink();
      updateEmbedCode();
    }

    /** Packaging **/
    var packageLink = querySelector('#package-link');
    var packageTurbo = querySelector('#package-turbo');
    var packageFullScreen = querySelector('#package-full-screen');

    function updatePackageLink() {
      if (player.projectId) {
        var url = location.origin + '/app.html';
        url += '?id=' + player.projectId;
        url += '&turbo=' + packageTurbo.checked;
        url += '&full-screen=' + packageFullScreen.checked;
        packageLink.href = url;
      } else {
        packageLink.href = 'about:blank';
      }
    }
    packageTurbo.addEventListener('change', updatePackageLink);
    packageFullScreen.addEventListener('change', updatePackageLink);

    /** Embedding **/
    var embedCode = querySelector('#embed-code');
    var embedAutoStart = querySelector('#embed-auto-start');
    var embedLightContent = querySelector('#embed-light-content');
    var embedHideControls = querySelector('#embed-hide-controls');

    function updateEmbedCode(e) {
      // Hide UI replaces other options.
      embedAutoStart.disabled = embedHideControls.checked;
      embedLightContent.disabled = embedHideControls.checked;
      if (embedHideControls.checked) {
        embedAutoStart.checked = true;
        embedLightContent.checked = false;
      }

      if (player.projectId) {
        var source = location.protocol + '//' + location.host + '/embed.js?id=' + player.projectId;
        if (embedHideControls.checked) {
          source += '&ui=false';
        } else {
          source += '&auto-start=' + embedAutoStart.checked;
          source += '&light-content=' + embedLightContent.checked;
        }
        // We need to break up the closing script tag, otherwise things break.
        embedCode.value = '<script src="' + source + '"></scrip' + 't>';
      } else {
        embedCode.value = '';
      }

      // Focus the embed code if we are an event callback
      if (e) {
        selectEmbedCode();
      }
    }
    function selectEmbedCode() {
      embedCode.select();
    }
    embedCode.addEventListener('focus', selectEmbedCode);
    embedCode.addEventListener('click', selectEmbedCode);
    embedHideControls.addEventListener('change', updateEmbedCode);
    embedAutoStart.addEventListener('change', updateEmbedCode);
    embedLightContent.addEventListener('change', updateEmbedCode);

    /** Local File Loading **/
    var uploadFileInput = querySelector('#upload-file-input');

    function cancelDragEvent(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'copy';
    }
    document.body.addEventListener('dragover', cancelDragEvent);
    document.body.addEventListener('dragenter', cancelDragEvent);
    document.body.addEventListener('drop', function(e) {
      e.preventDefault();
      var file = e.dataTransfer.files[0];
      if (file) {
        loadProjectFile(file);
      }
    });
    uploadFileInput.addEventListener('change', function(e) {
      var file = e.target.files[0];
      if (file) {
        loadProjectFile(file);
      }
    });

    /** Studio selector **/
    var examples = querySelector('#examples');
    var examplesContainer = querySelector('#examples-container');
    var examplesViewContainer = querySelector('#examples-view');
    var examplesFooter = querySelector('#examples-footer');
    examplesContainer.style.height = '0px';
    var studioView = null;
    function hideStudioView() {
      examplesContainer.style.height = '0px';
      if (studioView && studioView.visible && studioView.root.parentNode) {
        examplesViewContainer.removeChild(studioView.root);
      }
    }
    function initStudioView() {
      studioView = new StudioView(STUDIO);
      studioView.visible = false;
      studioView.onselect = function(id) {
        location.hash = '#' + id;
      };
      studioView.shuffleProjects = true;
      studioView.loadNextPage();
      studioView.setTheme(document.documentElement.classList.contains('dark') ? 'dark' : 'light');

      var link = document.createElement('a');
      link.innerText = player.getString('studio.view');
      link.target = '_blank';
      link.rel = 'noopener';
      link.href = STUDIO_PREFIX + STUDIO;
      examplesFooter.appendChild(link);
    }
    examples.addEventListener('click', function(e) {
      if (!studioView) {
        initStudioView();
      }
      if (studioView.visible) {
        hideStudioView();
      } else {
        examplesViewContainer.appendChild(studioView.root);
        examplesContainer.style.height = studioViewAreaHeight + 'px';
      }
      studioView.visible = !studioView.visible;
    });

    /** Dark Mode **/
    function getLocalDarkMode() {
      try {
        const value = localStorage.getItem('userPrefersDark');
        if (!value) {
          // value is undefined or null
          return getDefaultDarkMode();
        }
        // value is the string 'true' or the string 'false'
        return value === 'true';
      } catch (e) {
        console.warn('error getting local color choice', e);
        return false;
      }
    }
    function getDefaultDarkMode() {
      return window.matchMedia('(prefers-color-scheme: dark)').matches;
    }
    function setDarkMode(dark) {
      if (dark) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
      player.setTheme(dark ? 'dark' : 'light');
      if (studioView) {
        studioView.setTheme(dark ? 'dark' : 'light');
      }
      try {
        return localStorage.setItem('userPrefersDark', dark);
      } catch (e) {
        console.error('error saving color choice', e);
      }
    }
    function toggleDarkMode(dark) {
      setDarkMode(!document.documentElement.classList.contains('dark'));
    }
    querySelector('.theme-select a').addEventListener('click', function() {
      toggleDarkMode();
    });
    setDarkMode(getLocalDarkMode());

    /** Settings Menu **/
    var optionFramerate = querySelector('#settings-framerate');
    var optionUsername = querySelector('#settings-username');
    var settingsMenu = querySelector('#settings');
    var defaultOptions = {
      username: '',
      framerate: 30,
    };
    var previousOptions = shallowClone(defaultOptions);

    // Set the DOM to match the options
    function setSelectedOptions(options) {
      optionFramerate.value = options.framerate;
      optionUsername.value = options.username;
    }
    // Get the current options from the DOM
    function getSelectedOptions() {
      var options = shallowClone(previousOptions);

      // do not apply invalid framerate values because things break
      if (optionFramerate.checkValidity()) {
        options.framerate = +optionFramerate.value;
      }

      // doesn't really matter if username is "invalid"
      options.username = optionUsername.value;

      return options;
    }
    // Apply options to the stage.
    function applyOptions(options) {
      var stage = player.stage;

      // Applying framerate involves restarting the event loop, which we shouldn't do if not necessary
      if (options.framerate !== stage.runtime.framerate) {
        stage.runtime.framerate = options.framerate;
        if (stage.runtime.isRunning) {
          stage.runtime.resetInterval();
        }
      }

      stage.username = options.username;

      previousOptions = options;
    }
    // Gets the currently selected options, and applies them.
    function applySelectedOptions() {
      var options = getSelectedOptions();
      applyOptions(options);
    }

    setSelectedOptions(defaultOptions);
    optionFramerate.addEventListener('input', applySelectedOptions);
    optionUsername.addEventListener('input', applySelectedOptions);
    player.onload.subscribe(applySelectedOptions);

    if (initialId) {
      loadProjectId(initialId);
    }

  }());
  </script>

</body>

</html>
